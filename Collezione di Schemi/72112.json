{"$schema":"http:\/\/json-schema.org\/draft-06\/schema#","description":"Establishes the transaction interface that programs use apply mutations\/generate analytics.","additionalProperties":false,"title":"Program Transaction Schema","type":"object","definitions":{"_88rewardCreation":{"additionalProperties":false,"properties":{"___type":{"enum":["CREATE_REWARD"]},"___data":{"not":{"required":["dynamicProperties","overrideProperties"]},"additionalProperties":false,"title":"Reward Data","type":"object","properties":{"___rewardSource":{"type":"string","title":"Reward Source","enum":["FRIEND_SIGNUP","REFERRED","ACTIVATION","ACQUISITION","RETENTION","REACTIVATION","AUTOMATED"]},"___dynamicProperties":{"$eref":{"$schema":"http:\/\/json-schema.org\/draft-06\/schema#","description":"Defines the reward API data input structure.","title":"Reward API Input","type":"object","definitions":{"_88rewardDateScheduledFor":{"description":"If the reward is created in a PENDING state this is the date we will attempt to 'give' it","type":["integer","null"],"title":"Scheduled Reward Given Date"},"_88rewardCancellable":{"description":"Whether this reward can be cancelled","type":["boolean","null"],"title":"Cancellable"},"_88rewardUnit":{"description":"The unit of credit associated with this reward (i.e. months or usd)","type":"string","title":"Unit"},"_88rewardName":{"type":["string","null"],"title":"Reward Name"},"_88integrationSettings":{"type":"object","title":"Integration Settings","properties":{"___giftId":{"type":"string"},"___templateId":{"type":"string","title":"Email Template ID"},"___utid":{"type":"string"}}},"_88rewardDateExpires":{"description":"The date this reward will expire","type":["integer","null"],"title":"Reward Expiry Date"}},"properties":{"___type":{"type":"string","title":"Reward Type","enum":["PCT_DISCOUNT","FUELTANK","CREDIT","INTEGRATION"]}},"dependencies":{"type":{"oneOf":[{"additionalProperties":false,"properties":{"___name":{"$ref":"#\/definitions\/rewardName"},"___discountPercent":{"description":"The discount associated with this reward","maximum":100,"exclusiveMinimum":0,"title":"Discount Percent","type":"integer"},"___type":{"enum":["PCT_DISCOUNT"]},"___dateScheduledFor":{"$ref":"#\/definitions\/rewardDateScheduledFor"},"___cancellable":{"$ref":"#\/definitions\/rewardCancellable"},"___dateExpires":{"$ref":"#\/definitions\/rewardDateExpires"}},"required":["type","discountPercent"]},{"additionalProperties":false,"properties":{"___type":{"enum":["FUELTANK"]},"___fuelTankType":{"description":"The type of fuel tank reward being given","type":"string","title":"Fuel Tank Type","enum":["PCT_DISCOUNT","CREDIT"]},"___cancellable":{"$ref":"#\/definitions\/rewardCancellable"},"___amount":{"description":"The amount of credit or discount to be given","type":"string","title":"Amount"},"___fuelTankCode":{"description":"The associated coupon code uploaded via the fuel tank API or portal code manager","type":"string","title":"Fuel Tank Code"},"___dateExpires":{"$ref":"#\/definitions\/rewardDateExpires"},"___unit":{"$ref":"#\/definitions\/rewardUnit"}},"required":["type","fuelTankCode","fuelTankType","amount"]},{"additionalProperties":false,"properties":{"___name":{"$ref":"#\/definitions\/rewardName"},"___type":{"enum":["CREDIT"]},"___dateScheduledFor":{"$ref":"#\/definitions\/rewardDateScheduledFor"},"___cancellable":{"$ref":"#\/definitions\/rewardCancellable"},"___dateExpires":{"$ref":"#\/definitions\/rewardDateExpires"},"___assignedCredit":{"description":"The initial redeemable credit assigned to be assigned to reward","type":"integer","title":"Assigned Credit","exclusiveMinimum":0},"___unit":{"$ref":"#\/definitions\/rewardUnit"}},"required":["type","unit","assignedCredit"]},{"additionalProperties":false,"properties":{"___name":{"$ref":"#\/definitions\/rewardName"},"___description":{"description":"This text describes the integration reward given in more detail","type":"string","title":"Reward Description"},"___type":{"enum":["INTEGRATION"]},"___integrationSettings":{"$ref":"#\/definitions\/integrationSettings"},"___valueInCents":{"description":"The value in base currency unit (i.e. cents) to be assigned to this reward","type":"string","title":"Reward Amount"},"___unit":{"$ref":"#\/definitions\/rewardUnit"}},"required":["type","unit","valueInCents","integrationSettings"]}]}}},"type":"object","title":"If the reward is marked as dynamic by the program template these properties will be used to dynamically generate the reward. TODO describe user definition precedence?"},"___status":{"description":"This status defines the state the reward will be in when immediately after it is created","type":"string","title":"Initial Reward Status","enum":["AVAILABLE","PENDING","CANCELLED"]},"___key":{"description":"The program template key used to establish the relationship between this reward and the program","type":"string","title":"Reward Key"},"___user":{"$eref":{"description":"The mutation will be applied to this user","additionalProperties":false,"title":"Mutation User","type":"object","properties":{"___accountId":{"type":"string","title":"User Account ID"},"___id":{"type":"string","title":"User ID"}},"required":["id","accountId"]}},"___rewardId":{"description":"A unique BSON ObjectID used to identify the reward, if not set this will be auto-generated. Use this to link with emails.","type":["string","null"],"title":"Reward ID"},"___overrideProperties":{"description":"Properties included here will override or be added to properties setup via program reward configuration","additionalProperties":false,"title":"Reward Override","type":"object","properties":{"___dateScheduledFor":{"description":"If the reward is created in a PENDING state this is the date we will attempt to 'give' it","type":["integer","null"],"title":"Scheduled Reward Given Date"},"___dateExpires":{"description":"The date this reward is scheduled to expire if the reward is expirable","type":["integer","null"],"title":"Reward Expiry Date"}}},"___userEvent":{"additionalProperties":false,"type":["object","null"],"properties":{"___key":{"description":"The key of the event to be marked as a source of this reward","type":"string","title":"Event Key"},"___id":{"description":"The unique identifier of the event to be marked as a source of this reward","type":"string","title":"Event ID"}},"required":["key","id"]},"___referralId":{"description":"The referral ID for the event to be marked as a source of this reward","type":["string","null"],"title":"Referral ID"}},"required":["user","key"]}},"required":["type","data"]},"_88user":{"description":"The mutation will be applied to this user","additionalProperties":false,"title":"Mutation User","type":"object","properties":{"___accountId":{"type":"string","title":"User Account ID"},"___id":{"type":"string","title":"User ID"}},"required":["id","accountId"]},"_88mutation":{"type":"object","title":"Program Mutation","properties":{"___type":{"description":"The type of mutation to be performed","type":"string","title":"Mutation Type","enum":["CREATE_REWARD","SEND_EMAIL","MODERATE_GRAPH_NODES"]}},"dependencies":{"type":{"oneOf":[{"$eref":{"additionalProperties":false,"properties":{"___type":{"enum":["CREATE_REWARD"]},"___data":{"not":{"required":["dynamicProperties","overrideProperties"]},"additionalProperties":false,"title":"Reward Data","type":"object","properties":{"___rewardSource":{"type":"string","title":"Reward Source","enum":["FRIEND_SIGNUP","REFERRED","ACTIVATION","ACQUISITION","RETENTION","REACTIVATION","AUTOMATED"]},"___dynamicProperties":{"type":"object","title":"If the reward is marked as dynamic by the program template these properties will be used to dynamically generate the reward. TODO describe user definition precedence?","$ref":"RewardApiInput.schema.json#"},"___status":{"description":"This status defines the state the reward will be in when immediately after it is created","type":"string","title":"Initial Reward Status","enum":["AVAILABLE","PENDING","CANCELLED"]},"___key":{"description":"The program template key used to establish the relationship between this reward and the program","type":"string","title":"Reward Key"},"___user":{"$ref":"#\/definitions\/user"},"___rewardId":{"description":"A unique BSON ObjectID used to identify the reward, if not set this will be auto-generated. Use this to link with emails.","type":["string","null"],"title":"Reward ID"},"___overrideProperties":{"description":"Properties included here will override or be added to properties setup via program reward configuration","additionalProperties":false,"title":"Reward Override","type":"object","properties":{"___dateScheduledFor":{"description":"If the reward is created in a PENDING state this is the date we will attempt to 'give' it","type":["integer","null"],"title":"Scheduled Reward Given Date"},"___dateExpires":{"description":"The date this reward is scheduled to expire if the reward is expirable","type":["integer","null"],"title":"Reward Expiry Date"}}},"___userEvent":{"additionalProperties":false,"type":["object","null"],"properties":{"___key":{"description":"The key of the event to be marked as a source of this reward","type":"string","title":"Event Key"},"___id":{"description":"The unique identifier of the event to be marked as a source of this reward","type":"string","title":"Event ID"}},"required":["key","id"]},"___referralId":{"description":"The referral ID for the event to be marked as a source of this reward","type":["string","null"],"title":"Referral ID"}},"required":["user","key"]}},"required":["type","data"]}},{"$eref":{"additionalProperties":false,"properties":{"___type":{"enum":["MODERATE_GRAPH_NODES"]},"___data":{"additionalProperties":false,"title":"Reward Data","type":"object","properties":{"___moderationInput":{"additionalProperties":false,"type":"object","properties":{"___action":{"description":"The moderation action to apply to the filtered graph node(s)","type":"string","title":"Moderation Action","enum":["APPROVE","DENY","NOTHING"]},"___maxDepth":{"description":"The maximum depth of child nodes to be moderated","type":"integer","title":"Max Depth"}},"required":["action","maxDepth"]},"___filter":{"description":"A GraphQL filter that defines the node(s) to be moderated. See RewardFilterInput, ProgramEmailTransactionFilterInput, ProgramReferralFilterInput, and UserEventDataFilterInput","type":"object","title":"Moderation Filter"},"___graphNodeType":{"description":"The type of the graph node(s) to be moderated","type":"string","title":"Graph Node Type","enum":["REWARD","PROGRAM_EMAIL","REFERRAL","USER_EVENT","PAYMENT_ACCOUNT"]}},"required":["graphNodeType","filter","moderationInput"]}},"required":["type","data"]}},{"$eref":{"additionalProperties":false,"properties":{"___type":{"enum":["SEND_EMAIL"]},"___data":{"additionalProperties":false,"title":"Email Data","type":"object","properties":{"___query":{"description":"The GraphQL query used to build the context for this email","type":"string","title":"Email Query"},"___status":{"description":"The initial email status, if not set this will default to QUEUED","type":"string","title":"Email Status","enum":["PENDING","QUEUED"]},"___key":{"description":"The program template key of the email to send","type":"string","title":"Email Key"},"___user":{"$ref":"#\/definitions\/user"},"___queryVariables":{"description":"This variables object parameterizes the GraphQL Email query","type":"object","title":"Email Query Variables"},"___rewardId":{"description":"If included this defines the reward that will be available in the email render context","type":["string","null"],"title":"Email Reward ID"}},"required":["key","user","query","queryVariables"]}},"required":["type","data"]}}]}}},"_88moderateGraphNodes":{"additionalProperties":false,"properties":{"___type":{"enum":["MODERATE_GRAPH_NODES"]},"___data":{"additionalProperties":false,"title":"Reward Data","type":"object","properties":{"___moderationInput":{"additionalProperties":false,"type":"object","properties":{"___action":{"description":"The moderation action to apply to the filtered graph node(s)","type":"string","title":"Moderation Action","enum":["APPROVE","DENY","NOTHING"]},"___maxDepth":{"description":"The maximum depth of child nodes to be moderated","type":"integer","title":"Max Depth"}},"required":["action","maxDepth"]},"___filter":{"description":"A GraphQL filter that defines the node(s) to be moderated. See RewardFilterInput, ProgramEmailTransactionFilterInput, ProgramReferralFilterInput, and UserEventDataFilterInput","type":"object","title":"Moderation Filter"},"___graphNodeType":{"description":"The type of the graph node(s) to be moderated","type":"string","title":"Graph Node Type","enum":["REWARD","PROGRAM_EMAIL","REFERRAL","USER_EVENT","PAYMENT_ACCOUNT"]}},"required":["graphNodeType","filter","moderationInput"]}},"required":["type","data"]},"_88analytics":{"additionalProperties":false,"title":"Program Analytic","type":"object","properties":{"___eventType":{"description":"The type of event to record as an analytic","type":"string","title":"Event Type","enum":["PROGRAM_EVALUATED","PROGRAM_GOAL"]},"___data":{"description":"Event data - currently just program which only requires the user","additionalProperties":false,"title":"Event Data","type":"object","properties":{"___analyticsDedupeId":{"pattern":"^[a-zA-Z0-9_]*$","description":"An ID unique in the recording of this analytic that will be used to deduplicate (i.e. with goals this could be the number of times the referrer was rewarded)","type":"string"},"___timestamp":{"description":"The date this analytic will be marked as recorded (defaults to current tenant time if not set)","type":"integer","exclusiveMinimum":0},"___user":{"$eref":{"description":"The mutation will be applied to this user","additionalProperties":false,"title":"Mutation User","type":"object","properties":{"___accountId":{"type":"string","title":"User Account ID"},"___id":{"type":"string","title":"User ID"}},"required":["id","accountId"]}},"___programType":{"description":"The type of program (i.e. acquisition, loyalty, retention)","type":"string","enum":["ACQUISITION","RETENTION","LOYALTY"]},"___analyticsKey":{"pattern":"^[a-zA-Z0-9_]*$","description":"The type of analytic recorded (i.e. in program goals this could describe the goal achieved such as 'friendPaid')","type":"string"}},"required":["user"],"dependencies":{"analyticsKey":{"required":["analyticsDedupeId"]},"analyticsDedupeId":{"required":["analyticsKey"]}}}},"required":["eventType","data"]},"_88sendEmail":{"additionalProperties":false,"properties":{"___type":{"enum":["SEND_EMAIL"]},"___data":{"additionalProperties":false,"title":"Email Data","type":"object","properties":{"___query":{"description":"The GraphQL query used to build the context for this email","type":"string","title":"Email Query"},"___status":{"description":"The initial email status, if not set this will default to QUEUED","type":"string","title":"Email Status","enum":["PENDING","QUEUED"]},"___key":{"description":"The program template key of the email to send","type":"string","title":"Email Key"},"___user":{"$eref":{"description":"The mutation will be applied to this user","additionalProperties":false,"title":"Mutation User","type":"object","properties":{"___accountId":{"type":"string","title":"User Account ID"},"___id":{"type":"string","title":"User ID"}},"required":["id","accountId"]}},"___queryVariables":{"description":"This variables object parameterizes the GraphQL Email query","type":"object","title":"Email Query Variables"},"___rewardId":{"description":"If included this defines the reward that will be available in the email render context","type":["string","null"],"title":"Email Reward ID"}},"required":["key","user","query","queryVariables"]}},"required":["type","data"]}},"properties":{"___analytics":{"description":"A list of analytics representing activities performed by the program","type":"array","title":"Analytics","items":{"$eref":{"additionalProperties":false,"title":"Program Analytic","type":"object","properties":{"___eventType":{"description":"The type of event to record as an analytic","type":"string","title":"Event Type","enum":["PROGRAM_EVALUATED","PROGRAM_GOAL"]},"___data":{"description":"Event data - currently just program which only requires the user","additionalProperties":false,"title":"Event Data","type":"object","properties":{"___analyticsDedupeId":{"pattern":"^[a-zA-Z0-9_]*$","description":"An ID unique in the recording of this analytic that will be used to deduplicate (i.e. with goals this could be the number of times the referrer was rewarded)","type":"string"},"___timestamp":{"description":"The date this analytic will be marked as recorded (defaults to current tenant time if not set)","type":"integer","exclusiveMinimum":0},"___user":{"$ref":"#\/definitions\/user"},"___programType":{"description":"The type of program (i.e. acquisition, loyalty, retention)","type":"string","enum":["ACQUISITION","RETENTION","LOYALTY"]},"___analyticsKey":{"pattern":"^[a-zA-Z0-9_]*$","description":"The type of analytic recorded (i.e. in program goals this could describe the goal achieved such as 'friendPaid')","type":"string"}},"required":["user"],"dependencies":{"analyticsKey":{"required":["analyticsDedupeId"]},"analyticsDedupeId":{"required":["analyticsKey"]}}}},"required":["eventType","data"]}}},"___programId":{"type":"string","title":"Program Identifier"},"___mutations":{"description":"These are actions we would like to be performed by the program engine (i.e. creating a reward or sending an email)","type":"array","title":"Mutations","items":{"$eref":{"type":"object","title":"Program Mutation","properties":{"___type":{"description":"The type of mutation to be performed","type":"string","title":"Mutation Type","enum":["CREATE_REWARD","SEND_EMAIL","MODERATE_GRAPH_NODES"]}},"dependencies":{"type":{"oneOf":[{"$ref":"#\/definitions\/rewardCreation"},{"$ref":"#\/definitions\/moderateGraphNodes"},{"$ref":"#\/definitions\/sendEmail"}]}}}}}},"required":["programId"]}